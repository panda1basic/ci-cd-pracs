include:
  - local: pipelines/templates/bases.yml

deploy:prepare:
  tags:
    - builder
  extends:
    - .base
    - .base-pr4
  script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod -R 700 ~/.ssh
    - >
      ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa deployer@89.169.1.105
      "export IMAGE_NAME=$IMAGE_NAME && 
      envsubst < deployment.yaml"
  variables:
    IMAGE_NAME: burmatovdd/k8s-app:$CI_COMMIT_SHA

#      "cd /home/deployer/db-project/src/pr7/ &&
#      sed -i.bak '/PROD_IMAGE_$APP_DIR/ c\PROD_IMAGE_$APP_DIR=burmatovdd/$APP_DIR:$CI_COMMIT_SHA' ./.env"


deploy:run:
  tags:
    - builder
  extends:
    - .base
  needs:
    - deploy:prepare
  script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod -R 700 ~/.ssh
    - >
      ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa deployer@89.169.1.105
      "kubectl apply -f deployment.yaml"

#      "cd /home/deployer/db-project/src/pr7/ &&
#      docker compose up -d"