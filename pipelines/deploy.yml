#deploy:
#  tags:
#    - deployer
#  script:
#    - unset DOCKER_HOST
#    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
#    - docker pull burmatovdd/flask-app:$CI_COMMIT_SHA
#    - docker stop flask-app || true
#    - docker rm -f flask-app || true
#    - docker run -d --name flask-app -p 80:5000 burmatovdd/flask-app:$CI_COMMIT_SHA

deploy:
  tags:
    - builder
  script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod -R 700 ~/.ssh
    - >
      ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa deployer@89.169.1.105
      "sed -i.bak '/burmatovdd\/flask-app/ c\PROD_IMAGE=burmatovdd/flask-app:$CI_COMMIT_SHA' /home/deployer/.env"
