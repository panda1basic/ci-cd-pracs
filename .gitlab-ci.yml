stages:
  - lint
  - testing
  - push
  - deploy

variables:
  PROJECT_PATH: src/pr3

linting:
  stage: lint
  trigger:
    strategy: depend
    include:
      - local: pipelines/python-linter.yml
  variables:
    REQUIREMENTS_PATH: $PROJECT_PATH

testing:
  stage: testing
  needs:
    - linting
  trigger:
    strategy: depend
    include:
      - local: pipelines/python-tests.yml
  variables:
    TEST_PATH: auto_tests/test_app.py
    REQUIREMENTS_PATH: src/pr3

push:
  stage: push
  needs:
    - testing
  trigger:
    strategy: depend
    include:
      - local: pipelines/push.yml
  variables:
    REQUIREMENTS_PATH: $PROJECT_PATH

deploy:
  stage: deploy
  tags:
    - security
  script:
    - unset DOCKER_HOST
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
    - docker pull burmatovdd/flask-app:$CI_COMMIT_SHA
    - docker run d -p 80:5000 burmatovdd/flask-app:$CI_COMMIT_SHA
